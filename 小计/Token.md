什么是Token

- 服务端生成的一串加密字符串，简称“令牌”；当用户第一次使用账号密码成功进行登录后，服务器便生成一个Token及Token失效时间并将此返回给客户端，若成功登陆，以后客户端只需在有效时间内带上这个Token前来请求数据即可，无需再次带上用户名和密码。<br />登录流程：<br />![登录流程.gif](https://cdn.nlark.com/yuque/0/2022/gif/28163149/1665709164385-cc0d2e61-f63f-451d-a61f-312d3488b224.gif#averageHue=%23fdfdfd&clientId=ua66ab6e2-8c29-4&from=paste&height=576&id=u2e8c766d&originHeight=720&originWidth=1280&originalType=binary&ratio=1&rotation=0&showTitle=false&size=631448&status=done&style=none&taskId=u05eb5a79-367f-48a3-8b5d-85cc49035a5&title=&width=1024)<br />Token能解决什么问题
- token可以避免CSRF攻击(跨站点请求伪造) 
   - CSRF攻击详情网站https://zhuanlan.zhihu.com/p/114750961
- token可以多个服务器共享
- Token是在服务端产生的。如果前端使用用户名/密码向服务端请求认证，服务端认证成功，那么在服务端会返回Token给前端。前端可以在每次请求的时候带上Token证明自己的合法地位。如果这个Token在服务端持久化（比如存入数据库），那它就是一个永久的身份令牌。
- Token完全由应用管理，所以它可以避开同源策略<br />Token的生命周期

1. 用户未登录<br />用户执行注册/登录→ 一旦基础数据校验成功，后端生成Token，并且Token包含此次注册/登录用户的用户名并通过响应数据返回给前端→<br />前端拿到返回的Token后，存入浏览器本地存储
2. 用户每次访问页面<br />前端从本地存储拿出token→将token添加在请求头里→发送http请求→<br />后端拿到请求头进行token校验→校验不通过返回异常(后端可以配置全局异常捕获，自定义异常) /<br />校验通过返回数据→前端拿到数据开始渲染页面 / 如果拿到token异常响应,前端则删除本地存储的token，并让用户返回登录页重新登录<br />设置token有效期<br />其实Token作为一个概念模型，开发者完全可以针对自己开发的应用自定义Token，只要能做到不让不法分子钻系统漏洞即可。<br />那么为Token设置有效期还有必要吗？<br />对于这个问题，大家不妨先看两个例子：<br />例1：登录密码<br />登录密码一般要求定期改变密码，以防止泄漏，所以密码是有有效期的。<br />例2：安全证书<br />SSL安全证书都有有效期，目的是为了解决吊销的问题。<br />所以无论是从安全的角度考虑，还是从吊销的角度考虑，Token都需要设有效期。<br />那么，Token的有效期多长合适呢？<br />一般来说，基于系统安全的需要当然需要尽可能的短，但也不能短得离谱：如果在用户正常操作的过程中，Token过期失效要求重新登录，用户体验岂不是很糟糕？<br />为了解决在操作过程不让用户感到Token失效的问题，有一种方案是在服务器端保存Token状态，用户每次操作都会自动刷新（推迟）Token的过期时间。<br />如此操作会存在一个问题，即在前后端分离、单页App等情况下，每秒可能发起多次请求，如果每次都去刷新过期时间会产生非常大的代价，同样地，如果Token的过期时间被持久化到数据库或文件，代价就更大了。所以通常为了提升效率、减少消耗，会把Token的过期时保存在缓存或者内存中。<br />另一种方案是使用RefreshToken，它可以避免频繁的读写操作。这种方案中，服务端无需刷新Token的过期时间，一旦Token过期，就反馈给前端，前端使用RefreshToken申请一个全新Token继续使用。<br />这种方案中，服务端只需要在客户端请求更新Token的时候对RefreshToken的有效性进行一次检查，大大减少了更新有效期的操作，也就避免了频繁读写。当然RefreshToken也是有有效期的，但是这个有效期就可以长一点了。<br />使用 Token 和 Refresh Token 的时序图如下：<br />1）登录<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/28163149/1665709197475-318b9d98-0b61-43a6-998a-9195625d6081.png#averageHue=%23e8ebe8&clientId=ua66ab6e2-8c29-4&from=paste&height=298&id=udae76d8b&originHeight=373&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110986&status=done&style=none&taskId=ue1a24c1b-440e-4b83-afe5-1347a237c2c&title=&width=512)<br />2）业务请求<br />![download_image.jpeg](https://cdn.nlark.com/yuque/0/2022/jpeg/28163149/1665709218790-403c50a2-e8b1-463a-936d-4d60c80dd9f1.jpeg#averageHue=%23f6f8f4&clientId=ua66ab6e2-8c29-4&from=paste&height=234&id=u440908fa&originHeight=293&originWidth=510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20678&status=done&style=none&taskId=u506166b8-02fc-415e-918f-982376d6e23&title=&width=408)<br />图：来源于网络

3）Token 过期，刷新 Token<br />![download_image (1).jpeg](https://cdn.nlark.com/yuque/0/2022/jpeg/28163149/1665709236922-faa5558a-13da-499d-929f-311062b5c107.jpeg#averageHue=%23f0f2ef&clientId=ua66ab6e2-8c29-4&from=paste&height=526&id=u8cf61de2&originHeight=658&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40228&status=done&style=none&taskId=u97d8a2cc-e6e5-48fa-a837-59f7c3badb3&title=&width=512)
